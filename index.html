<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>La Mesa Cafe — Admin Panel</title>
<style>
:root{
  --bg:#fffaf6; --accent:#7b3f00; --muted:#6b5750; --card:#fff;
  --shadow:0 6px 18px rgba(0,0,0,0.08); --accent-2:#dba15a;
  font-synthesis:none;
}
*{box-sizing:border-box;}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#2b2b2b;}
header{background:linear-gradient(90deg,var(--accent-2),var(--accent));padding:20px;color:#fff;text-align:center;}
h1,h2,h3,h4,h5,h6{margin:0;}
main{padding:24px 6%;}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--shadow);margin-bottom:18px;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;text-align:left;border-bottom:1px solid #ddd;font-size:14px;}
th{background:var(--accent-2);color:#fff;}
button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700;margin-right:6px;}
button.secondary{background:transparent;color:var(--accent);border:2px solid var(--accent);}
select{padding:6px 10px;border-radius:6px;border:1px solid #ccc;margin-right:8px;}
.stats{margin-top:12px;font-weight:700;font-size:16px;}
.status-pending{background:#ffeaa7;color:#6b5500;padding:2px 6px;border-radius:6px;font-weight:700;}
.status-completed{background:#55efc4;color:#2d7a4c;padding:2px 6px;border-radius:6px;font-weight:700;}
@media(max-width:700px){table,th,td{font-size:12px;padding:6px;}}
</style>
</head>
<body>

<header>
  <h1>La Mesa Café — Admin Panel</h1>
</header>

<main>
  <div class="card">
    <h3>Controls</h3>
    <div style="margin-top:12px;">
      <select id="sortOrders">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
      </select>
      <button id="exportCSV">Export CSV</button>
    </div>
    <div class="stats">Total Revenue: <span id="totalRevenue">₱0</span></div>
  </div>

  <div class="card">
    <h3>Orders</h3>
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Customer</th>
          <th>Note</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="ordersTable">
        <!-- Orders populate here -->
      </tbody>
    </table>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, onChildAdded, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7QVhaR95hO_dUYcP7dJ__2DW0blpMKFI",
  authDomain: "la-mesa-cafe-system.firebaseapp.com",
  databaseURL: "https://la-mesa-cafe-system-default-rtdb.firebaseio.com",
  projectId: "la-mesa-cafe-system",
  storageBucket: "la-mesa-cafe-system.appspot.com",
  messagingSenderId: "234244615396",
  appId: "1:234244615396:web:87725489a3f70fbbabd0f1",
  measurementId: "G-9CL7KJTYVB"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let orders = [];
const ordersTable = document.getElementById("ordersTable");
const totalRevenueEl = document.getElementById("totalRevenue");
const sortSelect = document.getElementById("sortOrders");

function renderOrders(){
  ordersTable.innerHTML="";
  let totalRevenue=0;
  const sorted = [...orders];
  if(sortSelect.value==="newest") sorted.sort((a,b)=>b.timestamp-a.timestamp);
  else sorted.sort((a,b)=>a.timestamp-b.timestamp);

  sorted.forEach(order=>{
    let itemsStr = order.items.map(i=>`${i.name} (${i.qty}×₱${i.price})`).join("; ");
    const statusClass = order.status==="completed"?"status-completed":"status-pending";
    let row = document.createElement("tr");
    row.innerHTML=`
      <td>${new Date(order.timestamp).toLocaleString()}</td>
      <td>${order.customer}</td>
      <td>${order.note||""}</td>
      <td>${itemsStr}</td>
      <td>₱${order.total}</td>
      <td class="${statusClass}">${order.status||"pending"}</td>
      <td>
        ${order.status==="pending"?`<button onclick="markCompleted('${order.id}')">Mark Completed</button>`:""}
      </td>
    `;
    ordersTable.appendChild(row);
    totalRevenue+=order.total;
  });
  totalRevenueEl.textContent=`₱${totalRevenue}`;
}

// Fetch orders from Firebase and keep ID
const ordersRef = ref(db,"orders");
onValue(ordersRef,snapshot=>{
  orders=[];
  snapshot.forEach(child=>{
    let order = child.val();
    order.id=child.key;
    if(!order.status) order.status="pending";
    orders.push(order);
  });
  renderOrders();
  if(Notification.permission==="granted" && orders.length>0){
    const latest = orders[orders.length-1];
    new Notification("New Order!",{body:`Customer: ${latest.customer}\nTotal: ₱${latest.total}`});
  }
});

window.markCompleted=function(id){
  update(ref(db,"orders/"+id),{status:"completed"});
};

sortSelect.addEventListener("change",renderOrders);

document.getElementById("exportCSV").addEventListener("click",()=>{
  let csv="Timestamp,Customer,Note,Items,Total,Status\n";
  orders.forEach(order=>{
    let itemsStr=order.items.map(i=>`${i.name} (${i.qty}×₱${i.price})`).join("; ");
    csv+=`"${new Date(order.timestamp).toLocaleString()}","${order.customer}","${order.note||""}","${itemsStr}",${order.total},${order.status}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=`la-mesa-orders-${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});

if(Notification.permission!=="granted") Notification.requestPermission();
</script>

</body>
</html>
